/******************************************************************************
 *	ctrl.c								      *
 *	2018/dec/26							      *
 ******************************************************************************/


/******************************************************************************
 ******* headers **************************************************************
 ******************************************************************************/
/* Standard C ----------------------------------------------------------------*/
	#include <stdbool.h>
	#include <stddef.h>
	#include <stdint.h>

/* Drivers -------------------------------------------------------------------*/
	#include "stm32l4xx_hal.h"

/* libalx --------------------------------------------------------------------*/
/* STM32L4 modules -----------------------------------------------------------*/
	#include "can.h"
	#include "delay.h"
	#include "errors.h"
	#include "nunchuk.h"
	#include "tim.h"

/* project -------------------------------------------------------------------*/
	#include "ctrl_tst.h"


/******************************************************************************
 ******* macros ***************************************************************
 ******************************************************************************/


/******************************************************************************
 ******* structs **************************************************************
 ******************************************************************************/


/******************************************************************************
 ******* variables ************************************************************
 ******************************************************************************/
/* Global --------------------------------------------------------------------*/
/* Static --------------------------------------------------------------------*/


/******************************************************************************
 ******* static functions (prototypes) ****************************************
 ******************************************************************************/
static	int	modules_init		(void);
static	int	proc_ctrl_report	(void *data);


/******************************************************************************
 ******* main *****************************************************************
 ******************************************************************************/
int	proc_ctrl_tst_init	(void)
{
	if (modules_init()) {
		return	ERROR_NOK;
	}

	return	ERROR_OK;
}

int	proc_ctrl_tst	(void)
{
	while (true) {
		if (proc_ctrl_report(NULL)) {
			error_handle();
			return	ERROR_NOK;
		}
		delay_us(10000000u);
	}

	return	ERROR_OK;
}


/******************************************************************************
 ******* static functions (definitions) ***************************************
 ******************************************************************************/
static	int	modules_init		(void)
{
	if (delay_us_init()) {
		return	ERROR_NOK;
	}
	if (can_init()) {
		return	ERROR_NOK;
	}

	return	ERROR_OK;
}

static	int	proc_ctrl_report	(void *data)
{
	int8_t	plane_pos [CAN_DATA_LEN];

	(void)data;

	plane_pos[0]	= 1;
	plane_pos[1]	= 2;
	plane_pos[2]	= 3;
	plane_pos[3]	= 4;
	plane_pos[4]	= 0;
	plane_pos[5]	= 5;
	plane_pos[6]	= 6;
	plane_pos[7]	= 7;

	if (can_msg_write((uint8_t *)plane_pos)) {
		return	ERROR_NOK;
	}

	return	ERROR_OK;
}


/******************************************************************************
 ******* end of file **********************************************************
 ******************************************************************************/
